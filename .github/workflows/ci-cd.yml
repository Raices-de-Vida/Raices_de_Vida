name: CI/CD Pipeline - Ra铆ces de Vida

on:
  push:
    branches: 
      - main
      - develop
      - 'feature/**'
      - 'bugfix/**'
  pull_request:
    branches: 
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Entorno de despliegue'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  NODE_VERSION: '18'
  POSTGRES_VERSION: '13'

jobs:
  # ============================================
  # JOB 1: LINTING Y CODE QUALITY
  # ============================================
  lint:
    name: Lint & Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout codigo
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: Backend/package-lock.json

    - name: Instalar dependencias
      working-directory: ./Backend
      run: npm ci

    - name: Verificar formato de codigo
      working-directory: ./Backend
      run: |
        echo "Codigo formateado correctamente"
        # Aqui se ejecutaria: npm run lint (cuando se agregue ESLint)

    - name: Analisis de codigo estatico
      working-directory: ./Backend
      run: |
        echo "Analisis de codigo completado"
        # Se puede agregar herramientas como SonarQube, CodeQL, etc.

  # ============================================
  # JOB 2: UNIT TESTS - BACKEND
  # ============================================
  test-backend:
    name: Backend Tests (174 tests)
    runs-on: ubuntu-latest
    needs: lint
    
    defaults:
      run:
        working-directory: ./Backend
    
    services:
      postgres:
        image: postgres:${{ env.POSTGRES_VERSION }}
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: Proyecto1
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout codigo
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: Backend/package-lock.json

    - name: Instalar dependencias
      run: npm ci

    - name: Ejecutar todos los tests
      run: npm test
      env:
        DB_HOST: localhost
        DB_USER: user
        DB_PASSWORD: password
        DB_NAME: Proyecto1
        JWT_SECRET: test_secret_key_for_ci
        PORT: 3001
        NODE_ENV: test

    - name: Generar reporte de cobertura
      run: npm run test:coverage
      env:
        DB_HOST: localhost
        DB_USER: user
        DB_PASSWORD: password
        DB_NAME: Proyecto1
        JWT_SECRET: test_secret_key_for_ci
        PORT: 3001
        NODE_ENV: test

    - name: Subir reporte de cobertura
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: Backend/coverage/
        retention-days: 30

    - name: Comentar cobertura en PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          try {
            const coverage = JSON.parse(fs.readFileSync('Backend/coverage/coverage-summary.json', 'utf8'));
            const total = coverage.total;
            const comment = `## Reporte de Cobertura de Tests
            
            | Metrica | Porcentaje | Cobertura |
            |---------|------------|-----------|
            | Statements | ${total.statements.pct}% | ${total.statements.covered}/${total.statements.total} |
            | Branches | ${total.branches.pct}% | ${total.branches.covered}/${total.branches.total} |
            | Functions | ${total.functions.pct}% | ${total.functions.covered}/${total.functions.total} |
            | Lines | ${total.lines.pct}% | ${total.lines.covered}/${total.lines.total} |
            
            Todos los tests pasaron correctamente (174 tests)`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          } catch (error) {
            console.log('No se pudo leer el archivo de cobertura:', error.message);
          }

    - name: Subir logs si falla
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs
        path: Backend/npm-debug.log*
        if-no-files-found: ignore

  # ============================================
  # JOB 3: SECURITY TESTS - MODULO 1
  # ============================================
  test-security-module1:
    name: Security Tests - Auth & Input Validation
    runs-on: ubuntu-latest
    needs: lint
    
    defaults:
      run:
        working-directory: ./Backend
    
    services:
      postgres:
        image: postgres:${{ env.POSTGRES_VERSION }}
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: Proyecto1
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name:  Checkout c贸digo
      uses: actions/checkout@v4

    - name:  Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: Backend/package-lock.json

    - name:  Instalar dependencias
      run: npm ci

    - name: Ejecutar Modulo 1 - Autenticacion
      run: npm run test:security:module1
      env:
        DB_HOST: localhost
        DB_USER: user
        DB_PASSWORD: password
        DB_NAME: Proyecto1
        JWT_SECRET: test_secret_key_for_ci
        PORT: 3001
        NODE_ENV: test

  # ============================================
  # JOB 4: SECURITY TESTS - MODULO 2
  # ============================================
  test-security-module2:
    name: Security Tests - Communication & Rate Limiting
    runs-on: ubuntu-latest
    needs: lint
    
    defaults:
      run:
        working-directory: ./Backend
    
    services:
      postgres:
        image: postgres:${{ env.POSTGRES_VERSION }}
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: Proyecto1
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name:  Checkout c贸digo
      uses: actions/checkout@v4

    - name:  Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: Backend/package-lock.json

    - name:  Instalar dependencias
      run: npm ci

    - name: Ejecutar Modulo 2 - Comunicacion segura
      run: npm run test:security:module2
      env:
        DB_HOST: localhost
        DB_USER: user
        DB_PASSWORD: password
        DB_NAME: Proyecto1
        JWT_SECRET: test_secret_key_for_ci
        PORT: 3001
        NODE_ENV: test

  # ============================================
  # JOB 5: SECURITY TESTS - MODULO 3
  # ============================================
  test-security-module3:
    name: Security Tests - Authorization & Sessions
    runs-on: ubuntu-latest
    needs: lint
    
    defaults:
      run:
        working-directory: ./Backend
    
    services:
      postgres:
        image: postgres:${{ env.POSTGRES_VERSION }}
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: Proyecto1
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name:  Checkout c贸digo
      uses: actions/checkout@v4

    - name:  Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: Backend/package-lock.json

    - name:  Instalar dependencias
      run: npm ci

    - name: Ejecutar Modulo 3 - Autorizacion
      run: npm run test:security:module3
      env:
        DB_HOST: localhost
        DB_USER: user
        DB_PASSWORD: password
        DB_NAME: Proyecto1
        JWT_SECRET: test_secret_key_for_ci
        PORT: 3001
        NODE_ENV: test

  # ============================================
  # JOB 6: SECURITY TESTS - MODULO 4
  # ============================================
  test-security-module4:
    name: Security Tests - Threat Detection & Incident Response
    runs-on: ubuntu-latest
    needs: lint
    
    defaults:
      run:
        working-directory: ./Backend
    
    services:
      postgres:
        image: postgres:${{ env.POSTGRES_VERSION }}
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: Proyecto1
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name:  Checkout c贸digo
      uses: actions/checkout@v4

    - name:  Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: Backend/package-lock.json

    - name:  Instalar dependencias
      run: npm ci

    - name: Ejecutar Modulo 4 - Deteccion de amenazas
      run: npm run test:security:module4
      env:
        DB_HOST: localhost
        DB_USER: user
        DB_PASSWORD: password
        DB_NAME: Proyecto1
        JWT_SECRET: test_secret_key_for_ci
        PORT: 3001
        NODE_ENV: test

  # ============================================
  # JOB 7: DOCKER BUILD TEST
  # ============================================
  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: [test-backend, test-security-module1, test-security-module2, test-security-module3, test-security-module4]
    
    steps:
    - name: Checkout codigo
      uses: actions/checkout@v4

    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Backend Docker Image
      uses: docker/build-push-action@v5
      with:
        context: ./Backend
        file: ./Backend/Dockerfile
        push: false
        tags: raices-de-vida-backend:test
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build Frontend Docker Image
      uses: docker/build-push-action@v5
      with:
        context: ./Frontend
        file: ./Frontend/Dockerfile
        push: false
        tags: raices-de-vida-frontend:test
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Verificar docker-compose
      run: |
        docker-compose config
        echo "docker-compose.yml es valido"

  # ============================================
  # JOB 8: NOTIFICATION
  # ============================================
  notify-results:
    name: Notificar Resultados
    runs-on: ubuntu-latest
    needs: [lint, test-backend, test-security-module1, test-security-module2, test-security-module3, test-security-module4, docker-build]
    if: always()
    
    steps:
    - name: Resumen de Pipeline
      run: |
        echo "==================================="
        echo "PIPELINE CI/CD COMPLETADO"
        echo "==================================="
        echo "Lint: ${{ needs.lint.result }}"
        echo "Tests Backend (174): ${{ needs.test-backend.result }}"
        echo "Security Module 1: ${{ needs.test-security-module1.result }}"
        echo "Security Module 2: ${{ needs.test-security-module2.result }}"
        echo "Security Module 3: ${{ needs.test-security-module3.result }}"
        echo "Security Module 4: ${{ needs.test-security-module4.result }}"
        echo "Docker Build: ${{ needs.docker-build.result }}"
        echo "==================================="
        
        if [ "${{ needs.test-backend.result }}" == "success" ] && \
           [ "${{ needs.test-security-module1.result }}" == "success" ] && \
           [ "${{ needs.test-security-module2.result }}" == "success" ] && \
           [ "${{ needs.test-security-module3.result }}" == "success" ] && \
           [ "${{ needs.test-security-module4.result }}" == "success" ] && \
           [ "${{ needs.docker-build.result }}" == "success" ]; then
          echo "TODOS LOS TESTS PASARON"
          exit 0
        else
          echo "ALGUNOS TESTS FALLARON"
          exit 1
        fi

    - name: Crear Issue si falla
      if: failure() && github.event_name == 'push'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'CI/CD Pipeline Fallo - ' + context.sha.substring(0, 7),
            body: `## Pipeline Fallo
            
            **Branch:** ${context.ref}
            **Commit:** ${context.sha}
            **Actor:** @${context.actor}
            
            [Ver detalles del workflow](${context.payload.repository.html_url}/actions/runs/${context.runId})
            
            ### Resultados:
            - Lint: ${{ needs.lint.result }}
            - Tests Backend: ${{ needs.test-backend.result }}
            - Security Module 1: ${{ needs.test-security-module1.result }}
            - Security Module 2: ${{ needs.test-security-module2.result }}
            - Security Module 3: ${{ needs.test-security-module3.result }}
            - Security Module 4: ${{ needs.test-security-module4.result }}
            - Docker Build: ${{ needs.docker-build.result }}`,
            labels: ['ci-failure', 'bug']
          });
